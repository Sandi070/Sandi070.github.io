<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misi Kesetimbangan Kimia: Hujan Meteor!</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f0f23;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 100vh;
            background-color: #000;
            border: 2px solid #444;
        }
        canvas {
            display: block;
            background: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80') no-repeat center center;
            background-size: cover;
        }
        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        .hud-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        /* Modal Soal */
        #quizModal, #startModal, #gameOverModal, #winModal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .hidden { display: none !important; }
        
        h2 { color: #ffcc00; margin-bottom: 20px; font-size: 1.5rem; }
        p { font-size: 1.1em; line-height: 1.5; }
        
        .option-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            width: 90%;
            max-width: 400px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.2s;
        }
        .option-btn:hover { background: #0b7dda; }
        
        .start-btn {
            background: #4CAF50;
            font-size: 20px;
            padding: 15px 30px;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .controls-hint {
            margin-top: 15px;
            font-size: 0.9em;
            color: #aaa;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div class="hud-item">❤️ Nyawa: <span id="livesDisplay">3</span></div>
        <div class="hud-item">⏳ Waktu: <span id="timeDisplay">05:00</span></div>
    </div>

    <div id="startModal">
        <h1 style="color: #00d2ff; text-shadow: 0 0 10px cyan;">TANTANGAN KESETIMBANGAN</h1>
        <p>Waktu: 5 Menit</p>
        <p>Waspada! Jumlah meteor akan bertambah banyak seiring waktu.</p>
        <p>Tertabrak? Jawab soal kimia dengan benar untuk lanjut!</p>
        <button class="start-btn" onclick="startGame()">MULAI MISI</button>
        <div class="controls-hint">Gerakkan pesawat dengan Panah Kiri/Kanan atau Sentuh Layar</div>
    </div>

    <div id="quizModal" class="hidden">
        <h2 id="q-text">Pertanyaan disini?</h2>
        <div id="options-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
    </div>

    <div id="gameOverModal" class="hidden">
        <h1 style="color: red; font-size: 3em;">MISI GAGAL</h1>
        <p>Nyawa Habis.</p>
        <button class="start-btn" onclick="location.reload()">Coba Lagi</button>
    </div>

    <div id="winModal" class="hidden">
        <h1 style="color: gold; font-size: 3em;">MISI SUKSES!</h1>
        <p>Kamu ahli dalam mengatasi tekanan!</p>
        <h2 style="color: white;">Nilai: 100</h2>
        <button class="start-btn" onclick="location.reload()">Main Lagi</button>
    </div>
</div>

<script>
    // --- KONFIGURASI GAME ---
    const TOTAL_TIME = 5 * 60; // 5 Menit
    const PLAYER_SPEED = 9; 
    const METEOR_SPEED_BASE = 3.5; 
    
    // Spawn Rate Awal (35 frame sekali). Semakin kecil angka = semakin banyak meteor.
    const SPAWN_RATE_START = 35; 
    const SPAWN_RATE_END = 10;   // Di akhir game, meteor muncul sangat cepat (chaos)

    // --- BANK SOAL KHUSUS (KONSEP, Kc, Kp) ---
    const questions = [
        // --- KONSEP DASAR & JENIS KESETIMBANGAN ---
        {
            q: "Keadaan setimbang dinamis tercapai apabila...",
            options: ["Massa reaktan sama dengan massa produk", "Laju reaksi ke kanan = laju reaksi ke kiri", "Reaksi berhenti total", "Volume gas di kedua ruas sama"],
            a: 1
        },
        {
            q: "Manakah yang merupakan contoh kesetimbangan heterogen?",
            options: ["N2(g) + 3H2(g) ⇌ 2NH3(g)", "2SO2(g) + O2(g) ⇌ 2SO3(g)", "CaCO3(s) ⇌ CaO(s) + CO2(g)", "H2(g) + I2(g) ⇌ 2HI(g)"],
            a: 2 // Ada fase padat (s) dan gas (g)
        },
        {
            q: "Pada persamaan reaksi: 2H2(g) + O2(g) ⇌ 2H2O(l), zat yang tidak dimasukkan dalam rumus Kc adalah...",
            options: ["H2(g)", "O2(g)", "H2O(l)", "Semua dimasukkan"],
            a: 2 // Cairan murni (l) tidak masuk
        },
        {
            q: "Dalam perhitungan Kp, fase zat yang diperhitungkan hanya...",
            options: ["Gas (g) saja", "Larutan (aq) saja", "Padat (s) dan Cair (l)", "Gas (g) dan Larutan (aq)"],
            a: 0
        },
        
        // --- RUMUS & PERHITUNGAN Kc ---
        {
            q: "Rumus tetapan kesetimbangan (Kc) untuk reaksi: BiCl3(aq) + H2O(l) ⇌ BiOCl(s) + 2HCl(aq) adalah...",
            options: ["Kc = [HCl]^2 / [BiCl3]", "Kc = [BiOCl][HCl]^2 / [BiCl3][H2O]", "Kc = [BiCl3] / [HCl]^2", "Kc = [HCl] / [BiCl3]"],
            a: 0 // H2O(l) dan BiOCl(s) diabaikan
        },
        {
            q: "Diketahui reaksi A(g) ⇌ 2B(g). Jika saat setimbang [A]=0,5 M dan [B]=2 M, berapakah nilai Kc?",
            options: ["2", "4", "8", "16"],
            a: 2 // Kc = [B]^2 / [A] = (2)^2 / 0.5 = 4 / 0.5 = 8
        },
        {
            q: "Jika nilai Kc sangat kecil (Kc << 1), maka pada kesetimbangan...",
            options: ["Produk melimpah", "Reaktan melimpah (sedikit produk)", "Laju reaksi sangat cepat", "Suhu sangat tinggi"],
            a: 1
        },
        {
            q: "Dalam wadah 2 Liter terdapat 4 mol gas NO2 saat setimbang. Berapakah konsentrasi [NO2]?",
            options: ["0.5 M", "2 M", "4 M", "8 M"],
            a: 1 // M = n/V = 4/2 = 2
        },

        // --- RUMUS & PERHITUNGAN Kp ---
        {
            q: "Rumus Kp untuk reaksi: 2SO2(g) + O2(g) ⇌ 2SO3(g) adalah...",
            options: ["Kp = (P_SO3) / (P_SO2 . P_O2)", "Kp = (P_SO3)^2 / ((P_SO2)^2 . P_O2)", "Kp = (P_SO2)^2 / (P_SO3)", "Kp = P_total"],
            a: 1
        },
        {
            q: "Diketahui reaksi P(g) ⇌ Q(g) + R(g). Jika tekanan parsial P=2 atm, Q=3 atm, R=4 atm. Berapa nilai Kp?",
            options: ["12", "6", "1.5", "0.6"],
            a: 1 // Kp = (3 * 4) / 2 = 12 / 2 = 6
        },

        // --- HUBUNGAN Kc DAN Kp ---
        {
            q: "Hubungan matematis antara Kp dan Kc adalah...",
            options: ["Kp = Kc (RT)", "Kp = Kc / (RT)", "Kp = Kc (RT)^Δn", "Kp = Kc + RT"],
            a: 2
        },
        {
            q: "Nilai Δn (selisih koefisien gas) untuk reaksi N2(g) + 3H2(g) ⇌ 2NH3(g) adalah...",
            options: ["-2", "-1", "1", "2"],
            a: 0 // Kanan(2) - Kiri(1+3) = 2 - 4 = -2
        },
        {
            q: "Kapan nilai Kp sama dengan Kc (Kp = Kc)?",
            options: ["Saat suhu tinggi", "Saat tekanan rendah", "Saat Δn = 0 (koefisien kiri = kanan)", "Saat berwujud padat"],
            a: 2
        },
        {
            q: "Pada reaksi H2(g) + I2(g) ⇌ 2HI(g), hubungan Kp dan Kc adalah...",
            options: ["Kp > Kc", "Kp < Kc", "Kp = Kc", "Tidak berhubungan"],
            a: 2 // Koefisien kiri (1+1=2) sama dengan kanan (2). Delta n = 0.
        },
        {
            q: "Jika Kc = 2 dan RT = 5. Berapakah Kp untuk reaksi dengan Δn = 2?",
            options: ["10", "20", "50", "100"],
            a: 2 // Kp = 2 * (5)^2 = 2 * 25 = 50
        }
    ];

    // --- VARIABEL GAME ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    function resize() {
        canvas.width = document.getElementById('gameContainer').clientWidth;
        canvas.height = document.getElementById('gameContainer').clientHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    let player = { x: canvas.width/2, y: canvas.height - 60, w: 40, h: 40, color: '#00d2ff' };
    let meteors = [];
    let lives = 3;
    let timeRemaining = TOTAL_TIME;
    let frameCount = 0;
    let gameRunning = false;
    let isPaused = false;
    let keys = {};
    let currentMeteorIndex = -1; 

    // Input Handler
    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => keys[e.key] = false);
    
    canvas.addEventListener('touchstart', (e) => {
        const touchX = e.touches[0].clientX;
        const rect = canvas.getBoundingClientRect();
        const x = touchX - rect.left;
        if(x < canvas.width / 2) keys['ArrowLeft'] = true;
        else keys['ArrowRight'] = true;
    });
    canvas.addEventListener('touchend', () => {
        keys['ArrowLeft'] = false;
        keys['ArrowRight'] = false;
    });

    function startGame() {
        document.getElementById('startModal').classList.add('hidden');
        lives = 3;
        timeRemaining = TOTAL_TIME;
        meteors = [];
        player.x = canvas.width / 2 - 20;
        gameRunning = true;
        isPaused = false;
        updateTimerDisplay();
        updateLivesDisplay();
        gameLoop();
        
        const timerInterval = setInterval(() => {
            if(!gameRunning) clearInterval(timerInterval);
            if(!isPaused && gameRunning) {
                timeRemaining--;
                updateTimerDisplay();
                if(timeRemaining <= 0) winGame();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeRemaining / 60);
        const s = timeRemaining % 60;
        document.getElementById('timeDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;
    }

    function updateLivesDisplay() {
        document.getElementById('livesDisplay').innerText = lives;
    }

    // --- LOGIKA SPAWN METEOR DINAMIS ---
    function spawnMeteor() {
        const size = Math.random() * 25 + 15; // Ukuran variasi
        
        // Hitung Progress Waktu (0.0 = Awal, 1.0 = Akhir Waktu)
        const timeElapsed = TOTAL_TIME - timeRemaining;
        const difficultyRatio = timeElapsed / TOTAL_TIME; 

        // 1. Kecepatan bertambah
        const speedBoost = difficultyRatio * 5; 
        
        meteors.push({
            x: Math.random() * (canvas.width - size),
            y: -size,
            w: size,
            h: size,
            speed: METEOR_SPEED_BASE + (Math.random() * 2) + speedBoost
        });
    }

    function showQuiz() {
        isPaused = true;
        const qIdx = Math.floor(Math.random() * questions.length);
        const qData = questions[qIdx];
        
        const modal = document.getElementById('quizModal');
        const qText = document.getElementById('q-text');
        const optsContainer = document.getElementById('options-container');
        
        qText.innerHTML = qData.q;
        optsContainer.innerHTML = '';
        
        qData.options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = opt; // Pakai innerHTML agar subscript terbaca
            btn.onclick = () => checkAnswer(index, qData.a);
            optsContainer.appendChild(btn);
        });
        
        modal.classList.remove('hidden');
    }

    function checkAnswer(selected, correct) {
        document.getElementById('quizModal').classList.add('hidden');
        
        if (selected === correct) {
            if(currentMeteorIndex > -1) meteors.splice(currentMeteorIndex, 1);
            isPaused = false;
        } else {
            lives--;
            updateLivesDisplay();
            if(currentMeteorIndex > -1) meteors.splice(currentMeteorIndex, 1);
            
            if (lives <= 0) {
                gameOver();
            } else {
                isPaused = false;
            }
        }
    }

    function gameOver() {
        gameRunning = false;
        document.getElementById('gameOverModal').classList.remove('hidden');
    }

    function winGame() {
        gameRunning = false;
        document.getElementById('winModal').classList.remove('hidden');
    }

    function update() {
        if (!gameRunning || isPaused) return;

        // Player Movement
        if (keys['ArrowLeft'] && player.x > 0) player.x -= PLAYER_SPEED;
        if (keys['ArrowRight'] && player.x < canvas.width - player.w) player.x += PLAYER_SPEED;

        frameCount++;

        // --- DINAMIS SPAWN RATE ---
        // Menghitung spawn rate saat ini berdasarkan waktu tersisa
        // Awal: spawn setiap 35 frame. Akhir: spawn setiap 10 frame (3.5x lebih banyak meteor)
        const timeElapsed = TOTAL_TIME - timeRemaining;
        const difficultyRatio = timeElapsed / TOTAL_TIME; 
        
        // Rumus interpolasi linear sederhana
        const currentSpawnRate = SPAWN_RATE_START - ((SPAWN_RATE_START - SPAWN_RATE_END) * difficultyRatio);
        
        // Gunakan Math.floor agar menjadi integer
        if (frameCount % Math.floor(currentSpawnRate) === 0) spawnMeteor();

        for (let i = 0; i < meteors.length; i++) {
            let m = meteors[i];
            m.y += m.speed;

            if (player.x < m.x + m.w &&
                player.x + player.w > m.x &&
                player.y < m.y + m.h &&
                player.h + player.y > m.y) {
                
                currentMeteorIndex = i;
                showQuiz();
            }

            if (m.y > canvas.height) {
                meteors.splice(i, 1);
                i--;
            }
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw Player
        ctx.fillStyle = player.color;
        ctx.shadowBlur = 10;
        ctx.shadowColor = player.color;
        ctx.beginPath();
        ctx.moveTo(player.x + player.w/2, player.y);
        ctx.lineTo(player.x + player.w, player.y + player.h);
        ctx.lineTo(player.x, player.y + player.h);
        ctx.fill();
        ctx.shadowBlur = 0; // Reset shadow

        // Draw Meteors
        ctx.fillStyle = '#ff4d4d';
        for (let m of meteors) {
            ctx.beginPath();
            ctx.arc(m.x + m.w/2, m.y + m.h/2, m.w/2, 0, Math.PI*2);
            ctx.fill();
        }
    }

    function gameLoop() {
        if (gameRunning) {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    }
</script>

</body>
</html>
